/* The usual includes */
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <math.h>
#include <string.h>
#include "cab.h"
#include <assert.h>

#include <zephyr/irq.h>
#include <zephyr/spinlock.h>




int glob_num=0;
int glob_dim=0;
uint8_t *  aux1;

int pos = 0;

cab * open_cab(char * name,int num,int dim, uint8_t *  first){
    
    glob_num = num+1;
    glob_dim = dim;
    

    cab* ptr = (cab*)malloc(sizeof(cab));
    if (ptr == NULL) { perror("open_cab"); exit(2); }

    char *str = (char*) malloc(strlen(name)*sizeof(char));

    int *a = (int*)malloc((num+1)*sizeof(int));
    
    ptr->array = a;
    int aux[glob_num];
    for (int i=0;i< glob_num;i++){
        aux[i] =0;
    }
    
    memcpy(ptr->array,aux,sizeof(aux));
    
    uint8_t * s ;
    s =  ( uint8_t * ) malloc((num+1)*dim*sizeof( uint8_t  ));
    // printf("%d",(num+1)*dim*sizeof( uint8_t  ));
    if (s == NULL) { free(ptr); perror("open_cab"); exit(2); }

    
    
    ptr->num = num;
    ptr->dim = dim;
    
    ptr->name = str;   
    strcpy(ptr->name, name);

    
    
    for (int i=0;i<dim;i++){
        s[i] = first[i];
    }
    ptr->img_base = &s[0];
    ptr->img_last = &s[0];
    
    return ptr;
    
}

uint8_t* reserve(cab * cab_id){
   
    int key = irq_lock();
    pos =0;
    uint8_t* aux_base = cab_id->img_base;


    for(int i = 0;i< glob_num;i++){
        if (aux_base !=  cab_id->img_last && cab_id->array[pos]==0){
            // printf("\npos: %d",pos);
            irq_unlock(key);
            return aux_base;
        }
        else{
            aux_base = aux_base + glob_dim;
            pos++;
        }
    }
    
    // printf("\n RESERVE NÃO É POSSIVEL - NAO HA BUFFERS DISPONIVEIS (%d BUFFERS EM USO)",pos);
    irq_unlock(key);
    return NULL;
   
   
    
    
    

}

void put_mes(uint8_t * buf_pointer,cab * cab_id){
    // printf("\nArray acessos: [");
	// 			get_array();
	// 		printf("]");
    int key = irq_lock();
    
    uint8_t * s = buf_pointer;
    cab_id->img_last = s;

    irq_unlock(key);
   
    
   
}

uint8_t* get_mes(cab * cab_id){
//  printf("\nArray acessos: [");
// 				get_array();
// 			printf("]");
    int key = irq_lock();
    uint8_t* get_mes = cab_id->img_last;
    // printf("\nAUmentei????");
    cab_id->array[pos]=cab_id->array[pos]+1;
    irq_unlock(key);
    return get_mes ;
    
    
}

void unget(uint8_t * mes_pointer, cab * cab_id){
    // printf("\nArray acessos: [");
	// 			get_array();
	// 		printf("]");
    int key = irq_lock();
    uint8_t* aux_base = cab_id->img_base;
    int i;
    for(i = 0;i< glob_num;i++){
        if(aux_base == mes_pointer){
            break;
        }
        aux_base = aux_base + glob_dim; 
    }
    // printf("\nI:%d",i);
    if(cab_id->array[i]>0){
        if(mes_pointer != cab_id->img_last){
            cab_id->array[i]=cab_id->array[i]-1;
            // if(array_acessos[i]==0){
            //     free(aux_base);
            // }

        } else {
            // printf("\nUNGET A LAST BUFFER NAO E POSSIVEL");
        }
    } else {
        // printf("\nJÁ NÃO TEM TAREFAS");
    }
    
    irq_unlock(key);
}




 


/* Main function */
// int main(int argc, char *argv[]) {

// 	cab *cab_id;
//     uint8_t buffer_first[16][16] = {	{0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, 
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, 
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},					
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00} 
// 	};
//     cab_id = open_cab("ola",2,16*16,buffer_first);

//     for(int i=0;i<glob_num;i++){
//         printf("%d ",cab_id->array[i]);
//     }
//     uint8_t  * buffer_primeiro = get_mes(cab_id);
//     unget(buffer_primeiro,cab_id);
//     printf("\n");
//     // get_array();
//     uint8_t msg2[16][16] = {	{0x02, 0x80, 0xff, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, 
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, 
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},					
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00} 
// 	};

//     printf("\n\n\nLAST:");
//     for (int i=0;i<16*16;i++){
//         if (i%16==0){
//             printf("\n");
//         }
//         printf("%d ",*((cab_id->img_last)+i) );

//     }
//     printf("\n" );
//     printf("\nBASE1:");
//     for (int i=0;i<16*16;i++){
//         if (i%16==0){
//             printf("\n");
//         }
//         printf("%d ",*((cab_id->img_base)+i) );
//     }

//     printf("\n" );
//     printf("\nBASE2:");
//     for (int i=16*16;i<2*16*16;i++){
//         if (i%16==0){
//             printf("\n");
//         }
//         printf("%d ",*((cab_id->img_base)+i) );
//     }

//     printf("\n" );
//     printf("\nBASE3:");
//     for (int i=16*16*2;i<3*16*16;i++){
//         if (i%16==0){
//             printf("\n");
//         }
//         printf("%d ",*((cab_id->img_base)+i) );
//     }

    
//     uint8_t  * buffer = reserve(cab_id);
    
//     memcpy(buffer,msg2,sizeof(msg2));
//     put_mes(buffer,cab_id);
//     printf("\n");
//     for(int i=0;i<glob_num;i++){
//         printf("%d ",cab_id->array[i]);
//     }
//     // get_array();
//     printf("\n\n\nLAST:");
//     for (int i=0;i<16*16;i++){
//         if (i%16==0){
//             printf("\n");
//         }
//         printf("%d ",*((cab_id->img_last)+i) );

//     }
//     printf("\n" );
//     printf("\nBASE1:");
//     for (int i=0;i<16*16;i++){
//         if (i%16==0){
//             printf("\n");
//         }
//         printf("%d ",*((cab_id->img_base)+i) );
//     }

//     printf("\n" );
//     printf("\nBASE2:");
//     for (int i=16*16;i<2*16*16;i++){
//         if (i%16==0){
//             printf("\n");
//         }
//         printf("%d ",*((cab_id->img_base)+i) );
//     }

//     printf("\n" );
//     printf("\nBASE3:");
//     for (int i=16*16*2;i<3*16*16;i++){
//         if (i%16==0){
//             printf("\n");
//         }
//         printf("%d ",*((cab_id->img_base)+i) );
//     }

//     // get_mes(cab_id);

//     // unget(buffer,cab_id);
//     // get_mes(cab_id);
//     // get_mes(cab_id);
//     uint8_t msg3[16][16] = {	{0x03, 0x80, 0xff, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, 
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, 
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},					
// 		{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00} 
// 	};
//     uint8_t  * buffer2 = reserve(cab_id);
//     memcpy(buffer2,msg3,sizeof(msg3));
//     put_mes(buffer2,cab_id);
    


//        printf("\n\n\nLAST:");
//     for (int i=0;i<16*16;i++){
//         if (i%16==0){
//             printf("\n");
//         }
//         printf("%d ",*((cab_id->img_last)+i) );

//     }
//     printf("\n" );
//     printf("\nBASE1:");
//     for (int i=0;i<16*16;i++){
//         if (i%16==0){
//             printf("\n");
//         }
//         printf("%d ",*((cab_id->img_base)+i) );
//     }

//     printf("\n" );
//     printf("\nBASE2:");
//     for (int i=16*16;i<2*16*16;i++){
//         if (i%16==0){
//             printf("\n");
//         }
//         printf("%d ",*((cab_id->img_base)+i) );
//     }

//     printf("\n" );
//     printf("\nBASE3:");
//     for (int i=16*16*2;i<3*16*16;i++){
//         if (i%16==0){
//             printf("\n");
//         }
//         printf("%d ",*((cab_id->img_base)+i) );
//     }



    
    

 

//     // uint8_t msg4[16][16] = {	{0x04, 0x80, 0xff, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, 
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, 
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00},
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},					
// 	// 	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00} 
// 	// };
    
    
//     // uint8_t  * buffer4 = reserve(cab_id);
//     // memcpy(buffer4,msg3,sizeof(msg4));
//     // put_mes(buffer4,cab_id);
    

//     // printf("\nLAST:");
//     // for (int i=0;i<16*16;i++){
//     //     if (i%16==0){
//     //         printf("\n");
//     //     }
//     //     printf("%d ",*((cab_id->img_last)+i) );

//     // }
//     // printf("\n" );
//     // printf("\nBASE1:");
//     // for (int i=0;i<16*16;i++){
//     //     if (i%16==0){
//     //         printf("\n");
//     //     }
//     //     printf("%d ",*((cab_id->img_base)+i) );
//     // }

//     // printf("\n" );
//     // printf("\nBASE2:");
//     // for (int i=16*16;i<2*16*16;i++){
//     //     if (i%16==0){
//     //         printf("\n");
//     //     }
//     //     printf("%d ",*((cab_id->img_base)+i) );
//     // }

//     // printf("\n" );
//     // printf("\nBASE3:");
//     // for (int i=16*16*2;i<3*16*16;i++){
//     //     if (i%16==0){
//     //         printf("\n");
//     //     }
//     //     printf("%d ",*((cab_id->img_base)+i) );
//     // }

// }